"use strict";import{PosixClassNames as T,r as d}from"../utils.js";const o={Alternator:"Alternator",Assertion:"Assertion",Backreference:"Backreference",Character:"Character",CharacterClassClose:"CharacterClassClose",CharacterClassHyphen:"CharacterClassHyphen",CharacterClassIntersector:"CharacterClassIntersector",CharacterClassOpen:"CharacterClassOpen",CharacterSet:"CharacterSet",Directive:"Directive",GroupClose:"GroupClose",GroupOpen:"GroupOpen",Subroutine:"Subroutine",Quantifier:"Quantifier",EscapedNumber:"EscapedNumber"},h={any:"any",digit:"digit",dot:"dot",grapheme:"grapheme",hex:"hex",newline:"newline",posix:"posix",property:"property",space:"space",word:"word"},x={flags:"flags",keep:"keep"},g={absent_repeater:"absent_repeater",atomic:"atomic",capturing:"capturing",group:"group",lookahead:"lookahead",lookbehind:"lookbehind"},C={greedy:"greedy",lazy:"lazy",possessive:"possessive"},y=new Map([["a",7],["b",8],["e",27],["f",12],["n",10],["r",13],["t",9],["v",11]]),E=d`\[\^?`,$=`c.? | C(?:-.?)?|${d`[pP]\{(?:\^?[-\x20_]*[A-Za-z][-\x20\w]*\})?`}|${d`x[89A-Fa-f]\p{AHex}(?:\\x[89A-Fa-f]\p{AHex})*`}|${d`u(?:\p{AHex}{4})? | x\{[^\}]*\}? | x\p{AHex}{0,2}`}|${d`o\{[^\}]*\}?`}|${d`\d{1,3}`}`,I=/[?*+][?+]?|\{(?:\d+(?:,\d*)?|,\d+)\}\??/,k=new RegExp(d`
  \\ (?:
    ${$}
    | [gk]<[^>]*>?
    | [gk]'[^']*'?
    | .
  )
  | \( (?:
    \? (?:
      [:=!>({]
      | <[=!]
      | <[^>]*>
      | '[^']*'
      | ~\|?
      | #(?:[^)\\]|\\.?)*
      | [^:)]*[:)]
    )?
    | \*
  )?
  | ${I.source}
  | ${E}
  | .
`.replace(/\s+/g,""),"gsu"),A=new RegExp(d`
  \\ (?:
    ${$}
    | .
  )
  | \[:(?:\^?\p{Alpha}+|\^):\]
  | ${E}
  | &&
  | .
`.replace(/\s+/g,""),"gsu");function P(e,t={}){const n={flags:"",...t,rules:{captureGroup:!1,singleline:!1,...t.rules}};if(typeof e!="string")throw new Error("String expected as pattern");const i=z(n.flags),a=[i.extended],p={captureGroup:n.rules.captureGroup,getCurrentModX:()=>a.at(-1),numOpenGroups:0,popModX(){a.pop()},pushModX(c){a.push(c)},replaceCurrentModX(c){a[a.length-1]=c},singleline:n.rules.singleline};let r=[],u;for(k.lastIndex=0;u=k.exec(e);){const c=F(p,e,u[0],k.lastIndex);c.tokens?r.push(...c.tokens):c.token&&r.push(c.token),c.lastIndex!==void 0&&(k.lastIndex=c.lastIndex)}const l=[];let f=0;r.forEach(c=>{c.type===o.GroupOpen&&(c.kind===g.capturing?c.number=++f:c.raw==="("&&l.push(c))}),f||l.forEach((c,S)=>{c.kind=g.capturing,c.number=S+1});const G=f||l.length;return r=r.map(c=>c.type===o.EscapedNumber?j(c,G):c).flat(),{tokens:r,flags:i}}function F(e,t,n,i){const[a,p]=n;if(a==="["){const r=M(t,n,i);return{tokens:r.tokens,lastIndex:r.lastIndex}}if(a==="\\"){if("AbBGyYzZ".includes(p))return{token:s(o.Assertion,n,{kind:n})};if(/^\\g[<']/.test(n)){if(!/^\\g(?:<[^>]+>|'[^']+')$/.test(n))throw new Error(`Invalid group name "${n}"`);return{token:s(o.Subroutine,n)}}if(/^\\k[<']/.test(n)){if(!/^\\k(?:<[^>]+>|'[^']+')$/.test(n))throw new Error(`Invalid group name "${n}"`);return{token:s(o.Backreference,n)}}if(p==="K")return{token:s(o.Directive,n,{kind:x.keep})};if(p==="N"||p==="R")return{token:s(o.CharacterSet,n,{kind:h.newline,negate:p==="N"})};if(p==="O")return{token:s(o.CharacterSet,n,{kind:h.any})};if(p==="X")return{token:s(o.CharacterSet,n,{kind:h.grapheme})};const r=O(n,{inCharClass:!1});return Array.isArray(r)?{tokens:r}:{token:r}}if(a==="("){if(n==="(*")throw new Error(`Unsupported named callout "${n}"`);if(n==="(?{")throw new Error(`Unsupported callout "${n}"`);if(n.startsWith("(?#")){if(t[i]!==")")throw new Error('Unclosed comment group "(?#"');return{lastIndex:i+1}}if(/^\(\?[-imx]+[:)]$/.test(n))return{token:W(n,e)};if(e.pushModX(e.getCurrentModX()),e.numOpenGroups++,n==="("&&!e.captureGroup||n==="(?:")return{token:s(o.GroupOpen,n,{kind:g.group})};if(n==="(?>")return{token:s(o.GroupOpen,n,{kind:g.atomic})};if(n==="(?="||n==="(?!"||n==="(?<="||n==="(?<!")return{token:s(o.GroupOpen,n,{kind:n[2]==="<"?g.lookbehind:g.lookahead,negate:n.endsWith("!")})};if(n==="("&&e.captureGroup||n.startsWith("(?<")&&n.endsWith(">")||n.startsWith("(?'")&&n.endsWith("'")){const r=s(o.GroupOpen,n,{kind:g.capturing});return n!=="("&&(r.name=n.slice(3,-1)),{token:r}}if(n.startsWith("(?~")){if(n==="(?~|")throw new Error(`Unsupported absent function kind "${n}"`);return{token:s(o.GroupOpen,n,{kind:g.absent_repeater})}}throw n==="(?("?new Error(`Unsupported conditional "${n}"`):new Error(`Invalid or unsupported group option "${n}"`)}if(n===")"){if(e.popModX(),e.numOpenGroups--,e.numOpenGroups<0)throw new Error('Unmatched ")"');return{token:s(o.GroupClose,n)}}if(n==="#"&&e.getCurrentModX()){const r=t.indexOf(`
`,i);return{lastIndex:r===-1?t.length:r}}if(/^\s$/.test(n)&&e.getCurrentModX()){const r=/\s+/y;return r.lastIndex=i,{lastIndex:r.exec(t)?r.lastIndex:i}}if(n===".")return{token:s(o.CharacterSet,n,{kind:h.dot})};if(n==="^"||n==="$"){const r=e.singleline?{"^":d`\A`,$:d`\Z`}[n]:n;return{token:s(o.Assertion,n,{kind:r})}}return n==="|"?{token:s(o.Alternator,n)}:I.test(n)?{token:X(n)}:(v(n),{token:s(o.Character,n,{value:n.codePointAt(0)})})}function M(e,t,n){const i=[s(o.CharacterClassOpen,t,{negate:t[1]==="^"})];let a=1,p;for(A.lastIndex=n;p=A.exec(e);){const r=p[0];if(r[0]==="["&&r[1]!==":")a++,i.push(s(o.CharacterClassOpen,r,{negate:r[1]==="^"}));else if(r==="]"){if(i.at(-1).type===o.CharacterClassOpen)i.push(s(o.Character,r,{value:93}));else if(a--,i.push(s(o.CharacterClassClose,r)),!a)break}else{const u=w(r);Array.isArray(u)?i.push(...u):i.push(u)}}return{tokens:i,lastIndex:A.lastIndex||e.length}}function w(e){if(e[0]==="\\")return O(e,{inCharClass:!0});if(e[0]==="["){const t=/\[:(?<negate>\^?)(?<name>[a-z]+):\]/.exec(e);if(!t||!T.has(t.groups.name))throw new Error(`Invalid POSIX class "${e}"`);return s(o.CharacterSet,e,{kind:h.posix,value:t.groups.name,negate:!!t.groups.negate})}return e==="-"?s(o.CharacterClassHyphen,e):e==="&&"?s(o.CharacterClassIntersector,e):(v(e),s(o.Character,e,{value:e.codePointAt(0)}))}function O(e,{inCharClass:t}){const n=e[1];if(n==="c"||n==="C")return U(e);if("dDhHsSwW".includes(n))return H(e);if(e.startsWith(d`\o{`))throw new Error(`Incomplete, invalid, or unsupported octal code point "${e}"`);if(/^\\[pP]\{/.test(e)){if(e.length===3)throw new Error(`Incomplete or invalid Unicode property "${e}"`);return D(e)}if(/^\\x[89A-Fa-f]\p{AHex}/u.test(e))try{const i=e.split(/\\x/).slice(1).map(u=>parseInt(u,16)),a=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}).decode(new Uint8Array(i)),p=new TextEncoder;return[...a].map(u=>{const l=[...p.encode(u)].map(f=>`\\x${f.toString(16)}`).join("");return s(o.Character,l,{value:u.codePointAt(0)})})}catch{throw new Error(`Multibyte code "${e}" incomplete or invalid in Oniguruma`)}if(n==="u"||n==="x")return s(o.Character,e,{value:N(e)});if(y.has(n))return s(o.Character,e,{value:y.get(n)});if(/\d/.test(n))return s(o.EscapedNumber,e,{inCharClass:t});if(e==="\\")throw new Error(d`Incomplete escape "\"`);if(n==="M")throw new Error(`Unsupported meta "${e}"`);if([...e].length===2)return s(o.Character,e,{value:e.codePointAt(1)});throw new Error(`Unexpected escape "${e}"`)}function s(e,t,n){return{type:e,raw:t,...n}}function U(e){const t=e[1]==="c"?e[2]:e[3];if(!t||!/[A-Za-z]/.test(t))throw new Error(`Unsupported control character "${e}"`);return s(o.Character,e,{value:t.toUpperCase().codePointAt(0)-64})}function W(e,t){let{on:n,off:i}=/^\(\?(?<on>[imx]*)(?:-(?<off>[-imx]*))?/.exec(e).groups;i??="";const a=(t.getCurrentModX()||n.includes("x"))&&!i.includes("x"),p=b(n),r=b(i),u={};if(p&&(u.enable=p),r&&(u.disable=r),e.endsWith(")"))return t.replaceCurrentModX(a),s(o.Directive,e,{kind:x.flags,flags:u});if(e.endsWith(":")){t.pushModX(a),t.numOpenGroups++;const l=s(o.GroupOpen,e,{kind:g.group});return(p||r)&&(l.flags=u),l}throw new Error(`Unexpected flag modifier "${e}"`)}function X(e){const t={};if(e[0]==="{"){const{min:n,max:i}=/^\{(?<min>\d*)(?:,(?<max>\d*))?/.exec(e).groups,a=1e5;if(+n>a||+i>a)throw new Error("Quantifier value unsupported in Oniguruma");t.min=+n,t.max=i===void 0?+n:i===""?1/0:+i,t.kind=e.endsWith("?")?C.lazy:C.greedy}else t.min=e[0]==="+"?1:0,t.max=e[0]==="?"?1:1/0,t.kind=e[1]==="+"?C.possessive:e[1]==="?"?C.lazy:C.greedy;return s(o.Quantifier,e,t)}function H(e){const t=e[1].toLowerCase();return s(o.CharacterSet,e,{kind:{d:h.digit,h:h.hex,s:h.space,w:h.word}[t],negate:e[1]!==t})}function D(e){const{p:t,neg:n,value:i}=/^\\(?<p>[pP])\{(?<neg>\^?)(?<value>[^}]+)/.exec(e).groups,a=t==="P"&&!n||t==="p"&&!!n;return s(o.CharacterSet,e,{kind:h.property,value:i,negate:a})}function b(e){const t={};return e.includes("i")&&(t.ignoreCase=!0),e.includes("m")&&(t.dotAll=!0),e.includes("x")&&(t.extended=!0),Object.keys(t).length?t:null}function z(e){if(!/^[imxDPSW]*$/.test(e))throw new Error(`Flags "${e}" includes unsupported value`);const t={ignoreCase:!1,dotAll:!1,extended:!1,digitIsAscii:!1,posixIsAscii:!1,spaceIsAscii:!1,wordIsAscii:!1};for(const n of e)t[{i:"ignoreCase",m:"dotAll",x:"extended",D:"digitIsAscii",P:"posixIsAscii",S:"spaceIsAscii",W:"wordIsAscii"}[n]]=!0;return t}function N(e){if(/^(?:\\u(?!\p{AHex}{4})|\\x(?!\p{AHex}{1,2}|\{\p{AHex}{1,8}\}))/u.test(e))throw new Error(`Incomplete or invalid escape "${e}"`);const t=e[2]==="{"?/^\\x\{\s*(?<hex>\p{AHex}+)/u.exec(e).groups.hex:e.slice(2);return parseInt(t,16)}function j(e,t){const{raw:n,inCharClass:i}=e,a=n.slice(1);if(!i&&(a!=="0"&&a.length===1||a[0]!=="0"&&+a<=t))return[s(o.Backreference,n)];const p=[],r=a.match(/^[0-7]+|\d/g);for(let u=0;u<r.length;u++){const l=r[u];let f;if(u===0&&l!=="8"&&l!=="9"){if(f=parseInt(l,8),f>127)throw new Error(d`Octal encoded byte above 177 unsupported "${n}"`)}else f=l.codePointAt(0);p.push(s(o.Character,(u===0?"\\":"")+l,{value:f}))}return p}function v(e){if([...e].length!==1)throw new Error(`Expected "${e}" to be a single code point`)}export{P as tokenize,h as TokenCharacterSetKinds,x as TokenDirectiveKinds,g as TokenGroupKinds,C as TokenQuantifierKinds,o as TokenTypes};
//# sourceMappingURL=tokenize.js.map
